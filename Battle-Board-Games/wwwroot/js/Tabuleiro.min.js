var ObterBatalha, MontarTabuleiro; $(function () { var a = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ":" + window.location.port : ""), e = null, o = null, t = null, r = null, i = null, n = !1, l = sessionStorage.getItem("accessToken"); ObterBatalha = function (e, o = !1) { var t = a + "/api/BatalhasAPI/" + e, r = {}; l && (r.Authorization = l), $.ajax({ type: "GET", url: t, headers: r }).done(function (a) { var e; o && !isMeuTurno(a) || (0 == (e = a).Estado ? null == e.ExercitoPretoId || null == e.ExercitoBrancoId ? ((null != e.ExercitoPreto && e.ExercitoPreto.Usuario.Email == sessionStorage.getItem("EmailUsuario") || null != e.ExercitoBranco && e.ExercitoBranco.Usuario.Email == sessionStorage.getItem("EmailUsuario")) && alert("Somente existe um jogador neste jogo. Favor esperar a entrada do outro jogador"), alert("O jogo encontra-se em um estado inconsistente. Por favor, espere.")) : alert("Volte ao Lobby para iniciar o jogo.") : (MontarTabuleiro(e), 10 == e.Estado || e.Estado)) }).fail(function (a, e) { alert("Código de Erro: " + a.status + "\n\n" + a.responseText) }) }, MontarTabuleiro = function (l) { t = []; var s, c = l, u = c.tabuleiro.elementosDoExercito, d = c.exercitoBrancoId, p = c.exercitoPretoId, g = sessionStorage.getItem("EmailUsuario"); for ($("#tabuleiro").empty(), s = 0; s < c.tabuleiro.altura; s++)for ($("#tabuleiro").append("<div id='linha_" + s.toString() + "' class='linha' >"), t[s] = [], j = 0; j < c.tabuleiro.largura; j++) { var m = "casa_" + s.toString() + "_" + j.toString(), E = s % 2 == 0 ? j % 2 == 0 ? "casa_branca" : "casa_preta" : j % 2 != 0 ? "casa_branca" : "casa_preta"; for ($("#linha_" + s.toString()).append("<div id='" + m + "' class='casa " + E + "' />"), x = 0; x < u.length; x++)u[x].saude <= 0 || u[x].posicao.altura == s && u[x].posicao.largura == j && (t[s][j] = u[x], u[x].exercitoId == d ? $("#" + m).append("<img src='" + u[x].imagem + "' class='peca flipped' id='" + m.replace("casa", "peca_preta") + "'/>") : u[x].exercitoId == p && $("#" + m).append("<img src='" + u[x].imagem + "' class='peca' id='" + m.replace("casa", "peca_branca") + "'/>")) } function f(a) { return a.turnoId == a.exercitoBrancoId ? a.exercitoBranco : a.exercitoPreto } function I(a) { return ExercitoTurno = f(a), ExercitoTurno.usuario.email == g || ExercitoTurno.usuario.username == g } function v(a) { return $("#" + a).children("img:first").attr("id") } $(".casa").click(function () { $("#" + e).removeClass("casa_selecionada"), e = $(this).attr("id"), $("#" + e).addClass("casa_selecionada"), $("#info_casa_selecionada").text(e); var n = e.split("_")[1], l = e.split("_")[2]; if (null == i) null == (o = v(e)) ? (i = null, o = "NENHUMA PECA SELECIONADA") : (i = document.getElementById(o), r = t[n][l]), $("#info_peca_selecionada").text(o.toString()); else { var s = { Altura: n, Largura: l }; null == v(e) ? ataque = !1 : ataque = !0; var u = { posicao: s, AutorId: f(c).usuarioId, BatalhaId: c.id, ElementoId: r.id, TipoMovimento: ataque ? "Atacar" : "Mover" }; I(c) && f(c).id == r.exercitoId ? function (e) { $.ajax({ type: "POST", url: a + "/api/BatalhasAPI/Jogar", contentType: "application/json; charset=utf-8", dataType: "json", data: JSON.stringify(e) }).done(function (a) { MontarTabuleiro(a) }).fail(function (a, e) { alert("Código de Erro: " + a.status + "\n\n" + a.responseText) }) }(u) : I(c) ? f(c).id != r.exercitoId && alert("Não é o seu exercito!") : alert("Não é a sua vez!"), i = null, $("#" + e).removeClass("casa_selecionada") } }), I(c) ? (n || window.setInterval(function () { ObterBatalha(c.id) }, 1e3), n = !0) : n = !1 } });